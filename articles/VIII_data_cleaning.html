<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIII. Data Cleaning • rnpn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="VIII. Data Cleaning">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rnpn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/I_introduction.html">I. Introduction</a>
    </li>
    <li>
      <a href="../articles/II_status_intensity.html">II. Status and Intensity Data</a>
    </li>
    <li>
      <a href="../articles/III_individual_phenometrics.html">III. Individual Phenometrics</a>
    </li>
    <li>
      <a href="../articles/IV_site_phenometrics.html">IV. Site Phenometrics</a>
    </li>
    <li>
      <a href="../articles/V_magnitude_phenometrics.html">V. Magnitude Phenometrics</a>
    </li>
    <li>
      <a href="../articles/VI_geospatial.html">VI. USA-NPN Geospatial Data</a>
    </li>
    <li>
      <a href="../articles/VII_combine_raster_point.html">VII. Putting It All Together</a>
    </li>
    <li>
      <a href="../articles/VIII_data_cleaning.html">VIII. Data Cleaning</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/usa-npn/rnpn/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>VIII. Data Cleaning</h1>
                        <h4 data-toc-skip class="author">Alyssa
Rosemartin</h4>
            
            <h4 data-toc-skip class="date">2025-09-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/usa-npn/rnpn/blob/master/vignettes/VIII_data_cleaning.Rmd" class="external-link"><code>vignettes/VIII_data_cleaning.Rmd</code></a></small>
      <div class="hidden name"><code>VIII_data_cleaning.Rmd</code></div>

    </div>

    
    
<p>This vignette describes four approaches to data cleaning that apply
to USA-NPN Observational data: 1. Conflicting Records, 2. Excluding Data
Based on Prior No, 3. Multiple First Yeses and 4. Removing Outliers for
Individual Plants over Time.</p>
<p>Note that complete information on data structure for USA-NPN
Observational data are documented in this report: Observational Data
Documentation (<a href="https://pubs.usgs.gov/of/2018/1060/ofr20181060.pdf" class="external-link uri">https://pubs.usgs.gov/of/2018/1060/ofr20181060.pdf</a>).</p>
<div class="section level2">
<h2 id="conflicting-records">1. Conflicting Records<a class="anchor" aria-label="anchor" href="#conflicting-records"></a>
</h2>
<div class="section level3">
<h3 id="in-status-and-intensity-data">In Status and Intensity Data<a class="anchor" aria-label="anchor" href="#in-status-and-intensity-data"></a>
</h3>
<p>As the least processed presentation of the data, this may be the best
data type to use for exploring potential data quality issues. The
exploration and elimination of status conflicts is readily accomplished
in this data type, as described below.</p>
<div class="section level4">
<h4 id="viewing-status-conflicts">Viewing Status Conflicts<a class="anchor" aria-label="anchor" href="#viewing-status-conflicts"></a>
</h4>
<p>When one or more observers report differing phenophase statuses on
the same individual plant or species of animal at a site, all records
are flagged with the “Observed_Status_Conflict_Flag”. This is a
character field with 3 allowed values: OneObserver-StatusConflict which
indicates that the same observer reported conflicting statuses,
MultiObserver-StatusConflict which indicates that more than one observer
reported conflicting statuses and -9999 which represents the absence of
a conflict (null). The following example for 2015-2021 Tuliptree data
(Species ID 82) shows how to explore conflicts by site. Options for
eliminating records are also given. First the data are downloaded, with
the additional field “Observed_Status_Conflict_Flag” included.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npn_download_status_data.html">npn_download_status_data</a></span><span class="op">(</span></span>
<span>  request_source <span class="op">=</span> <span class="st">'Your Name Here'</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2015</span><span class="op">:</span><span class="fl">2021</span><span class="op">)</span>,</span>
<span>  species_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">82</span><span class="op">)</span>,</span>
<span>  additional_fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Observed_Status_Conflict_Flag"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, summarize the number of multiple and single observer status
conflicts by site in a new data frame, with the use of the dplyr
package. The new column ‘Percent_Conflict’ gives the percent of all
records for a given phenophase with a single or multiple observer status
conflict.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">conflict_summary</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">observed_status_conflict_flag</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>observed_status_conflict_flag<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span></span>
<span>    <span class="va">observed_status_conflict_flag</span>,<span class="st">'MultiObserver-StatusConflict'</span><span class="op">=</span><span class="st">'Multi'</span>, <span class="st">'OneObserver-StatusConflict'</span><span class="op">=</span><span class="st">'One'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Percent_Conflict <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, drop the non-conflicting records, and visualize the percent of
each type of conflict, using bar plots in facet wrap by site, in
ggplot2.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">conflicts</span> <span class="op">&lt;-</span> <span class="va">conflict_summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observed_status_conflict_flag</span> <span class="op">!=</span> <span class="st">'-9999'</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">conflicts</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">observed_status_conflict_flag</span>, <span class="va">Percent_Conflict</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">conflicts</span><span class="op">$</span><span class="va">site_id</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Percent Multi and One Observer Status Conflict by Phenophase"</span><span class="op">)</span></span>
<span>     <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/conflicts-by-site.png" width="75%"></p>
<p>Note that the prior two steps can be repeated, replacing “site_id”
with “phenophase_description” to view conflicts by phenophase.</p>
</div>
<div class="section level4">
<h4 id="removing-status-conflicts">Removing Status Conflicts<a class="anchor" aria-label="anchor" href="#removing-status-conflicts"></a>
</h4>
<p>Further investigation of these patterns may inform what the user does
next. A user may opt to allow yes records to override no records (as
done in individual and site phenometrics), to investigate conflicts
further or remove all conflicting records.</p>
<p>Some sites where many observers collect data on the same plants (eg,
some college classes) have high percentages of conflicting records. To
drop all records at sites where more than 5% of the records are in
conflict:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_hi_conflict_sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">conflicts</span>, <span class="va">Percent_Conflict</span> <span class="op">&gt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">df_low_conflict_sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">df</span>, <span class="op">!</span><span class="va">site_id</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">hi_conflict_sites</span><span class="op">$</span><span class="va">site_id</span><span class="op">)</span> </span></code></pre></div>
<p>To drop ALL conflicting records:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_no_conflicts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">observed_status_conflict_flag</span> <span class="op">==</span> <span class="st">"-9999"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="in-individual-and-site-phenometric-data">In Individual and Site Phenometric Data<a class="anchor" aria-label="anchor" href="#in-individual-and-site-phenometric-data"></a>
</h3>
<p>The techniques described above can be applied to exploring and
removing conflicting records in Individual and Site Phenometrics. Users
should bear in mind that in these aggregated data sets, the presence of
the conflict flag indicates that conflicting records in the underlying
status data exists for <em>at least one of</em> the dates in the
series.</p>
</div>
</div>
<div class="section level2">
<h2 id="excluding-data-based-on-prior-no">2. Excluding Data Based on Prior No<a class="anchor" aria-label="anchor" href="#excluding-data-based-on-prior-no"></a>
</h2>
<p>When collecting data, observers report the presence (Yes) or absence
(No) of the phenophase on each day. Depending on the application, users
may wish to use all phenophase presence data, regardless of whether the
observer recently reported a prior absence (No). Alternatively, a user
may wish to exclude data without a prior no within a given number of
days (7, 14 and 21 days are commonly used cut offs).</p>
<p>In Status and Intensity data this must be done manually (assembling
first yes and prior no from the status records; not demonstrated
here).</p>
<p>In Individual Phenometrics, data can be readily explored and filtered
based on the timing of a prior no, demonstrated below.</p>
<p>In Site Phenometrics, since values for individual plants are
averaged, the mean_numdays_since_prior_no field can be used to explore
and filter the data. Note that in Site Phenometrics the user can control
the first yeses included in the site-level average using
‘num_days_quality_filter = “[insert # days here]”’, as an additional
parameter in the data call. By default first yeses without a prior no
within 30 days are excluded in this data type.</p>
<p>Note that there is a parallel field reflecting number of days between
the last yes (end of the phenophase) and the next no:
numdays_until_next_no (in Individual Phenometrics) and
mean_numdays_until_next_no (in Site Phenometrics).</p>
<p>To explore and filter data based on prior no in Individual
Phenometrics, first download all the flowering dogwood (Species ID 12)
for 2021:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npn_download_individual_phenometrics.html">npn_download_individual_phenometrics</a></span><span class="op">(</span></span>
<span>  request_source <span class="op">=</span> <span class="st">'Your Name Here'</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span>,</span>
<span>  species_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="viewing-data-by-prior-no">Viewing Data by Prior No<a class="anchor" aria-label="anchor" href="#viewing-data-by-prior-no"></a>
</h4>
<p>Next, set the -9999 values to NA, and plot a histogram and identify
the quantiles of the distribution of the number of days since the prior
no, for all the first yes records in this dataset:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>numdays_since_prior_no <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/na_if.html" class="external-link">na_if</a></span><span class="op">(</span><span class="va">numdays_since_prior_no</span>, <span class="st">"-9999"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">numdays_since_prior_no</span>,</span>
<span>     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,<span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span>,<span class="fl">35</span>,<span class="fl">42</span>,<span class="fl">100</span>,<span class="fl">250</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Histogram of Number of Days Since Prior No"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">numdays_since_prior_no</span>,</span>
<span>         probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span><span class="op">)</span>,</span>
<span>         na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/HistogramPriorNo.png" width="75%"></p>
</div>
<div class="section level4">
<h4 id="filtering-data-by-prior-no">Filtering Data by Prior No<a class="anchor" aria-label="anchor" href="#filtering-data-by-prior-no"></a>
</h4>
<p>The histogram and quantile information can inform the user’s decision
regarding where to set the filter, balancing how much data will be lost
against certainty of the date of true onset of the phenophase. Here we
show how to drop records without a prior no within 21 days.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">df_21d_prior_no</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">numdays_since_prior_no</span> <span class="op">&lt;</span> <span class="fl">21</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="multiple-first-yeses">3. Multiple First Yeses<a class="anchor" aria-label="anchor" href="#multiple-first-yeses"></a>
</h2>
<p>The Multiple First Yes field is only available for Individual
Phenometrics.</p>
<p>If the Multiple First Yes flag is set to “1” it indicates that for
that individual plant, for that phenophase, for that year, there were
multiple instances where the plant transitioned from a status of No to a
status of Yes. These can represent real phenomena, for instance a
drought deciduous tree that leafs out several times in a year, or a
dogwood that reblooms after a frost event. This can also occur when
observers are reporting on the same plant on sequential days but are not
in agreement on phenophase status with other observers. Note that by
design, Site Phenometrics don’t have Multiple First Yeses. For Site
Phenometrics, each series represents the average first yes date of all
the individuals of the species at the site, for that year, as described
in the Observational Data Documentation (<a href="https://pubs.usgs.gov/of/2018/1060/ofr20181060.pdf" class="external-link uri">https://pubs.usgs.gov/of/2018/1060/ofr20181060.pdf</a>).</p>
<p>A similar approach to the above workflow for status conflicts can be
followed in Individual Phenometrics to explore and exclude series with
multiple first yeses:</p>
<div class="section level3">
<h3 id="viewing-multiple-first-yeses">Viewing Multiple First Yeses<a class="anchor" aria-label="anchor" href="#viewing-multiple-first-yeses"></a>
</h3>
<p>First data are downloaded, with the additional field for multiple
first yes. Note that the user can also include the optional field
“multiple_observers” which indicates whether one or more observers
contributed to the series. This field may be useful in determining the
cause of multiple fires yeses.</p>
<p>Here we download flowering dogwood data (species ID 12) for 2021.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npn_download_individual_phenometrics.html">npn_download_individual_phenometrics</a></span><span class="op">(</span></span>
<span>  request_source <span class="op">=</span> <span class="st">'Your Name Here'</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span>,</span>
<span>  species_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  additional_fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"multiple_firsty"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next we can look at the frequency of series with multiple first
yeses, by phenophase.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">mfy_summary</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">phenophase_description</span>, <span class="va">multiple_firsty</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">phenophase_description</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Percent_MFY <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, exclude rows with no multiple first yeses from the summary, and
visualize the percent of multiple first yeses, using bar plots in facet
wrap by phenophase, in ggplot2.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">mfy</span> <span class="op">&lt;-</span> <span class="va">mfy_summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">mfy_summary</span><span class="op">$</span><span class="va">multiple_firsty</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mfy</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">multiple_firsty</span>, <span class="va">Percent_MFY</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">mfy</span><span class="op">$</span><span class="va">phenophase_description</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Frequency of Multiple First Yeses by Phenophase (Flowering Dogwood, 2021)"</span><span class="op">)</span></span>
<span>     <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/MFY-byPhenophase.png" width="75%"></p>
<p>In this example, there is a high frequency of series with multiple
first yeses! To examine what is happening in cases like this one, users
can look at the multiple_observer field to see how many of the series
with multiple first yeses also have multiple observers contributing
records. The underlying Status and Intensity data can also provide
further detail.</p>
</div>
<div class="section level3">
<h3 id="taking-the-mean-of-multiple-first-yeses">Taking the Mean of Multiple First Yeses<a class="anchor" aria-label="anchor" href="#taking-the-mean-of-multiple-first-yeses"></a>
</h3>
<p>Depending on users’ data explorations and planned uses, it may be
appropriate to take the earliest first yes for the
phenophase-individual-plant-year combination, or the latest or the mean.
Here is how to take the average first yes across all the series for each
phenophase-individual-plant combination, for the 2021 dogwood data we
downloaded above (be sure to also group by year if using multiple years
of data). This is done by grouping by phenophase and individual ID (and
year if multi year), and then adding a new column with the mean date of
first yes day of year. Then the user should drop the duplicate records
based on phenophase and individual ID (and year if multi year). Note
that there will still be a multiple first year column in this dataset,
but it no longer applies.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_one_firsty</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">phenophase_description</span>, <span class="va">individual_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean_firsty <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">first_yes_doy</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">phenophase_id</span>, <span class="va">individual_id</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="removing-outliers-for-individual-plants-over-time">4. Removing Outliers for Individual Plants over Time<a class="anchor" aria-label="anchor" href="#removing-outliers-for-individual-plants-over-time"></a>
</h2>
<p>When observers have looked at the same individual plant over many
years, certain records can be excluded based on falling to the extreme
of distribution of records (this is the approach used in Rosemartin et
al 2015, <a href="https://doi.org/10.1038/sdata.2015.38" class="external-link uri">https://doi.org/10.1038/sdata.2015.38</a>).</p>
<p>First, download 11 years of Red Oak (Species ID 102) Breaking Leaf
Bud (Phenophase ID 371) data, in the Individual Phenometrics format:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/npn_download_individual_phenometrics.html">npn_download_individual_phenometrics</a></span><span class="op">(</span></span>
<span>  request_source <span class="op">=</span> <span class="st">'Your Name Here'</span>, </span>
<span>  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2009</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span>, </span>
<span>  species_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">102</span><span class="op">)</span>,</span>
<span>  phenophase_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">371</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Visualize the unaltered data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">first_yes_doy</span><span class="op">~</span><span class="va">df</span><span class="op">$</span><span class="va">first_yes_year</span>, </span>
<span>  ylab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Day of Year"</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">350</span><span class="op">)</span>,</span>
<span>  cex<span class="op">=</span><span class="fl">2</span>,  cex.axis<span class="op">=</span><span class="fl">1.5</span>, cex.lab<span class="op">=</span><span class="fl">1.5</span>, pch<span class="op">=</span><span class="fl">21</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/RedOak1.png" width="75%"></p>
<p>Remove individual oak trees with less than 8 years of data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_8Y</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">individual_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">first_yes_year</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<p>Plotting the data again (as above) can show how reducing the data to
individuals with &gt;8 years of records impacts the data set.</p>
<p>Look at the distribution of first yes records for each individual
plant over the time period, identify the 25th and 75th quantiles and
interquantile range (IQR) of this distribution.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">df_8Y</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">individual_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>Q1 <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">first_yes_doy</span>, <span class="fl">.25</span><span class="op">)</span>, </span>
<span>                                  Q3 <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">first_yes_doy</span>, <span class="fl">.75</span><span class="op">)</span>,</span>
<span>                                  IQR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html" class="external-link">IQR</a></span><span class="op">(</span><span class="va">first_yes_doy</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Create a reference data frame which gives the quantiles and IQR by
individual ID</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_8Y_Q</span> <span class="op">=</span> <span class="va">df_8Y</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">quantiles</span>, by <span class="op">=</span> <span class="st">"individual_id"</span><span class="op">)</span></span></code></pre></div>
<p>Remove first yes records that fall outside of 1.5 times the
interquartile range for the individual plant.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_8Y_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span></span>
<span>  <span class="va">df_8Y_Q</span>, <span class="op">(</span><span class="va">df_8Y_Q</span><span class="op">$</span><span class="va">first_yes_doy</span> <span class="op">&gt;</span> <span class="op">(</span><span class="va">Q1</span> <span class="op">-</span> <span class="fl">1.5</span><span class="op">*</span><span class="va">df_8Y_Q</span><span class="op">$</span><span class="va">IQR</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>               <span class="va">df_8Y_Q</span><span class="op">$</span><span class="va">first_yes_doy</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">Q3</span> <span class="op">+</span> <span class="fl">1.5</span><span class="op">*</span><span class="va">df_8Y_Q</span><span class="op">$</span><span class="va">IQR</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Visualize the data with the outliers removed.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">df_8Y_clean</span><span class="op">$</span><span class="va">first_yes_doy</span><span class="op">~</span><span class="va">df_8Y_clean</span><span class="op">$</span><span class="va">first_yes_year</span>, </span>
<span>  ylab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Day of Year"</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">350</span><span class="op">)</span>,</span>
<span>  cex<span class="op">=</span><span class="fl">2</span>,  cex.axis<span class="op">=</span><span class="fl">1.5</span>, cex.lab<span class="op">=</span><span class="fl">1.5</span>, pch<span class="op">=</span><span class="fl">21</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/RedOak3.png" width="75%"></p>
<p>Huge thanks to Amanda Gallinat and Jeff Oliver for very helpful
review of this vignette.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jeff Switzer, Scott Chamberlain, Lee Marsh, Kevin Wong, Eric R Scott.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
